<html>
<head>
<title>ThermoBeacon</title>
<meta charset="utf-8"/>
<style>
  </style>

<script>
function handleNotifications(event) {//alert(event);
  let value = event.target.value;
  let a = [];
  // Convert raw data bytes to hex values just for the sake of showing something.
  // In the "real" world, you_d use data.getUint8, data.getUint16 or even
  // TextDecoder to process raw data bytes.
  for (let i = 0; i < value.byteLength; i++) {
    a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
    }
  //alert(document.getElementById("div_notification").innerHTML+'> ' + a.join(' '));
  document.getElementById("div_notification").innerHTML='> ' + a.join(' ');
  }

function ThermoBeacon_handleNotifications(val) {//alert(event);
  let value = [];
  let a = [];
  let b = [];
  if (ThermoBeacon.device) {
    value = event.target.value;
    for (let i = 0; i < value.byteLength; i++) b[i]=value.getUint8(i);
    } else b=val;
  for (let i = 0; i < b.length; i++) a.push('0x' + ('00' + b[i].toString(16)).slice(-2));
  log('notification=['+a+']');
  //alert(document.getElementById("div_notification").innerHTML+'> ' + a.join(' '));
  document.getElementById("div_notification").innerHTML='> ' + a.join(' ');
  }

//0x01 0x53 0x00 0x00 0x00 0x03 0x52 0x01 0x52 0x01 0x51 0x01 0x6f 0x04 0x6f 0x04 0x6f 0x04 0x00 0x00
//0x07 0x40 0x00 0x00 0x00 0x03 0x52 0x01 0x52 0x01 0x51 0x01 0x6f 0x04 0x6f 0x04 0x6f 0x04 0x00 0x00

</script>

<script>


/*
Disconnect
Forget

Name:
ThermoBeacon
Address:
FC:11:00:00:04:94
GATT Connected:
Connected
Latest RSSI:
-50
Services:
00001800-0000-1000-8000-00805f9b34fb, 00001801-0000-1000-8000-00805f9b34fb, 0000180a-0000-1000-8000-00805f9b34fb, 0000ffe0-0000-1000-8000-00805f9b34fb, 0000fff0-0000-1000-8000-00805f9b34fb
Manufacturer Data:
0x001b 0x00009404000011fc2a0b8301a205e0eb6a00
Service:
0000ffe0-0000-1000-8000-00805f9b34fb
Service Info

ID:
FC:11:00:00:04:94/0000ffe0-0000-1000-8000-00805f9b34fb,31
UUID:
0000ffe0-0000-1000-8000-00805f9b34fb
Type:
Primary
Characteristics
Characteristic:
0000fff3-0000-1000-8000-00805f9b34fb
Characteristic Info

ID:
FC:11:00:00:04:94/0000ffe0-0000-1000-8000-00805f9b34fb,31/0000fff3-0000-1000-8000-00805f9b34fb,36
UUID:
0000fff3-0000-1000-8000-00805f9b34fb
Properties

Notify:

*/
  </script>

<script>
let DASH={value2:(new DataView(new ArrayBuffer(8))),char2:{writeValue:function(value) {log(value)}}};
let CC_RT_BLE={};
let ThermoBeacon={};

async function device_request() {
  log();
  let options={};
  options.acceptAllDevices = true;
  options.optionalServices = [
    '00001800-0000-1000-8000-00805f9b34fb', //alle? name?
    'af237777-879d-6186-1f49-deca0e85d9c1', //robi
    '3e135142-654f-9090-134a-a6ff5bb77046', //cc-rt-ble (eq-3)
    '0000fff0-0000-1000-8000-00805f9b34fb', //ThermoBeacon
    '0000ffe0-0000-1000-8000-00805f9b34fb', //ThermoBeacon
    ] ;
  log('Requesting Bluetooth Device...');
  log('with options=' + JSON.stringify(options));
  let RET={};
  log("navigator.bluetooth="+navigator.bluetooth);
  log("navigator.bluetooth.getDevices="+navigator.bluetooth.getDevices);
  log("navigator.bluetooth.requestDevice="+navigator.bluetooth.requestDevice);
  //RET.devices=navigator.bluetooth.getDevices();
  RET.device=await navigator.bluetooth.requestDevice(options);
  log('> Name:             ' + RET.device.name);
  log('> Id:               ' + RET.device.id);
  log('> Connected:        ' + RET.device.gatt.connected);
  if (RET.device.name=='Robi') DASH = await kopple_Robi(RET);
  if (RET.device.name=='CC-RT-BLE') CC_RT_BLE = await kopple_CC_RT_BLE(RET);
  if (RET.device.name=='ThermoBeacon') ThermoBeacon = await kopple_ThermoBeacon(RET);
  return RET;
  }  

function log(text) {
  if (text) {
    div_log.innerHTML=div_log.innerHTML+'<div>'+text+'</div>';
    div_log.scrollTo({top:100000,left: 0,behavior: 'smooth'});
    } else {
      div_log.innerHTML='Neustart: '+Date();
      }
  }

function onDisconnected() {
  Ausgabe_Kopplung.innerHTML='disconnected';
  alert('disconnected\nwegen Button "trennen"\n(eventuell auch weil einige Zeit inaktiv?)');
  }

async function kopple_ThermoBeacon(dev) {
  Ausgabe_Kopplung.innerHTML='versuche zu verbinden (nach 5 sek erneut versuchen)';
  log('kopple_ThermoBeacon(device)');
  log('Connecting to GATT Server...');
  dev.device.addEventListener('gattserverdisconnected', onDisconnected);
  dev.server=await dev.device.gatt.connect();
  log('> Connected:        ' + dev.device.gatt.connected);

  log('Getting Service...'+dev.server);
  dev.service = await dev.server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
  log('> Service...'+dev.service.uuid);  

  log('Getting Characteristic...');
  dev.char6 = await dev.service.getCharacteristic('0000fff3-0000-1000-8000-00805f9b34fb');
  log('> Characteristic...'+dev.char6.uuid);
  
  log('Starting Notifications...');
  dev.notify=await dev.char6.startNotifications();
  log('> return flag='+dev.notify);
  dev.char6.addEventListener('characteristicvaluechanged',ThermoBeacon_handleNotifications);

  log('Getting Characteristic...');
  dev.char2 = await dev.service.getCharacteristic('0000fff5-0000-1000-8000-00805f9b34fb');
  log('> Characteristic...'+dev.char2.uuid);
  
  Ausgabe_Kopplung.innerHTML='verbunden, button_Test1()';
  setTimeout(function() {Ausgabe_Kopplung.innerHTML='verbunden';button_Test1.click()},500);
  
  return dev;
  }

  </script>
  
<script>
async function Test(x) {//alert(1);alert(CC_RT_BLE.device!=undefined);
  //if ((ThermoBeacon!=undefined)&&ThermoBeacon.device.gatt.connected) ; else alert('erst koppeln');
  log('writeValue(['+x.map(function(z,i) {return '0x'+('0'+z.toString(16)).slice(-2)})+'])');
  if (ThermoBeacon.device) {
    await ThermoBeacon.char2.writeValue(Uint8Array.of(...x));
    log('> writeValue() geschafft'); 
    }
//  alert('durch');
  }

  </script>

</head>
<body>
<style>.Ausgabe {font-family:Courier,monospace; font-size:100%; color:violet; border:solid; border-radius:4pt}</style>
<div>
  aktuell um <span id='Ausgabe_Uhrzeit' class='Ausgabe'>??:??</span> Uhr:
  Temperatur <span id='Ausgabe_Temperatur' class='Ausgabe'>?</span> <i>°C</i>,
  Feuchtigkeit <span id='Ausgabe_Feuchtigkeit' class='Ausgabe'>?</span> <i>%</i>,
  Batterie(?) <span id='Ausgabe_Batterie' class='Ausgabe'>?</span> <i>%</i>.
  </div>
<ul>
  <li>den <b>ThermoBeacon</b> über Bluetooth <span><button id='button_device_request' onclick="device_request()">koppeln</button></span>. <span id='Ausgabe_Kopplung' class='Ausgabe'>?</span>, <span><button id='button_device_request' onclick="ThermoBeacon.device.gatt.disconnect()">trennen</button></span></li>
  <li>Ausgabe <span><button id='button_aktualisieren' onclick='let jj=new Date();Test([0x03,jj.getFullYear()%100,jj.getMonth()+1,jj.getDate(),jj.getHours(),jj.getMinutes(),jj.getSeconds()])'>aktualisieren</button></span>.</li>
  </ul>
<div><span><button id='button_device_request' onclick="device_request()">device_request()</button></span></div>
<div><span><button id='button_Test4' onclick='Test([4,0,0,0,0,0])'>[0x04,0,0,0,0,0] blink</button></span></div>
<div><span><button id='button_Test1' onclick='Test([1,0,0,0,0,0])'>[0x01,0,0,0,0,0] get entries</button></span></div>
<div><span><button id='button_Test2' onclick='Test([2,0,0,0,0,0])'>[0x02,0,0,0,0,0] reboot</button></span></div>
<div><span><button id='button_Test7' onclick='Test([7,0x40,0,0,0,3])'>[0x07,0x40,0,0,0,3] get data</button></span></div>
<div><span><button id='button_disconnect' onclick="ThermoBeacon.device.gatt.disconnect()">trennen</button></span></div>
<div style="border:solid">
  <div id="div_log" style="display:flex; flex-direction:column; overflow:auto; height:200px; white-space:nowrap; font-family:Courier,monospace; font-size:100%">none</div>  
  </div>

<div id="div_notification" style="font-family:Courier,monospace"><i>notification</i></div>


<div><a href='https://github.com/emericg/WatchFlower/blob/master/docs/thermobeacon-ble-api.md#services-characteristics-and-handles'>https://github.com/emericg/WatchFlower/blob/master/docs/thermobeacon-ble-api.md#services-characteristics-and-handles</a></div>
<div><a href='https://github.com/rnlgreen/thermobeacon/blob/main/thermobeacon2.py'>https://github.com/rnlgreen/thermobeacon/blob/main/thermobeacon2.py</a></div>
<div><a href='https://googlechrome.github.io/samples/web-bluetooth/index.html'>https://googlechrome.github.io/samples/web-bluetooth/index.html</a></div>
<div><a href='https://developer.mozilla.org/en-US/docs/Web/API/Bluetooth'>https://developer.mozilla.org/en-US/docs/Web/API/Bluetooth</a></div>

<!--
 
struct(15): {
  .Name = string[12]: "ThermoBeacon"
  .Trusted = bool: false
  .Adapter = int: 0
  .LegacyPairing = bool: false
  .Paired = bool: false
  .ServicesResolved = bool: false
  .Alias = string[12]: "ThermoBeacon"
  .Connected = bool: false
  .ManufacturerData = array(1): {
                        [0] struct(2): {
                              .Value = array(20): {
                                         [0] int: 0
                                         [1] int: 0
                                         [2] int: 140
                                         [3] int: 7
                                         [4] int: 0
                                         [5] int: 0
                                         [6] int: 71
                                         [7] int: 233
                                         [8] int: 126
                                         [9] int: 1
                                         [10] int: 238
                                         [11] int: 13
                                         [12] int: 0
                                         [13] int: 0
                                         [14] int: 252
                                         [15] int: 0
                                         [16] int: 167
                                         [17] int: 140
                                         [18] int: 0
                                         [19] int: 0
                                       }
                              .Key = int: 17
                            }
                      }
  .Address = string[17]: "E9:47:00:00:07:8C"
  .Blocked = bool: false
  .RSSI = int: -68
  .Addresstype = string[6]: "public"
  .UUIDs = array(1): {
             [0] string[36]: "0000fff0-0000-1000-8000-00805f9b34fb"
           }
  .TxPower = int: 0
}
-->
   </body>
   </html>
